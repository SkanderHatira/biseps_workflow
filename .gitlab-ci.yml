image: docker:19.03.12
services:
  - docker:19.03.12-dind
stages:
  - build # Build docker image
  - dry-run # To make sure it infers rules correctly
  - minimal-run # To make sure it executes correctly with a given set of parameters
 

before_script:
 - mkdir -p $(pwd)/.test
 - mkdir -p $(pwd)/dock_result/
# minimal-run:
#   stage: dry-run
#   only:
#     - development
#   script:
#    - docker run --mount type=bind,src="$(pwd)/.test",dst=/dmr-pipe/.test,readonly -it --mount type=bind,src="$(pwd)/dock_result/",dst=/dmr-pipe/results dmr-pipe-reduced --configfile .test/config/config.yaml --cores 6 --use-conda 

# dry-run:
#   stage: minimal-run
#   only:
#     - development
#   script:
#     - source activate snakemake
#     - snakemake --cores 6 --use-conda --configfile .test/config/config.yaml

build:
  stage: build
  only: 
    - master
  script:
    # - docker build -t dmr-pipe-reduced --build-arg USER_ID=$CI_JOB_ID --build-arg GROUP_ID=$CI_JOB_ID --build-arg USERNAME=$CI_JOB_NAME .
    - docker -v
